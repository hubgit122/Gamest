!function(a){"use strict";a.touchLayer=function(b){return a.touchLayer=new m(b),a.touchLayer};var b=["input","select","textarea"],c=["button","radio","checkbox","range","date"],d=a.os.ios,e=a.os.blackberry,f=a.os.blackberry||a.os.fennec||a.os.android&&!a.os.chrome,g=a.os.ios&&!a.os.ios7,h=.97,i=2,j=!1,k=!1,m=function(b){this.clearTouchVars(),b.addEventListener("touchstart",this,!1),b.addEventListener("touchmove",this,!1),b.addEventListener("touchend",this,!1),b.addEventListener("click",this,!1),b.addEventListener("focusin",this,!1),document.addEventListener("scroll",this,!1),window.addEventListener("resize",this,!1),window.addEventListener("orientationchange",this,!1),this.layer=b,this.scrollEndedProxy_=a.proxy(this.scrollEnded,this),this.exitEditProxy_=a.proxy(this.exitExit,this,[]),this.launchFixUIProxy_=a.proxy(this.launchFixUI,this);var c=this;this.scrollTimeoutExpireProxy_=function(){c.scrollTimeout_=null,c.scrollTimeoutEl_.addEventListener("scroll",c.scrollEndedProxy_,!1)},this.retestAndFixUIProxy_=function(){a.os.android&&!a.os.chrome&&(c.layer.style.height="100%"),a.asap(c.testAndFixUI,c,arguments)},document.addEventListener("click",function(a){return k?(a.preventDefault(),a.stopPropagation(),!1):(void 0!==a.clientX&&null!==c.lastTouchStartX&&2>Math.abs(c.lastTouchStartX-a.clientX)&&2>Math.abs(c.lastTouchStartY-a.clientY)&&(a.preventDefault(),a.stopPropagation()),void 0)},!0),a.bind(this,"scrollstart",function(b){c.isScrolling=!0,c.scrollingEl_=b,a.feat.nativeTouchScroll||(c.scrollerIsScrolling=!0),c.fireEvent("UIEvents","scrollstart",b,!1,!1)}),a.bind(this,"scrollend",function(b){c.isScrolling=!1,a.feat.nativeTouchScroll||(c.scrollerIsScrolling=!1),c.fireEvent("UIEvents","scrollend",b,!1,!1)}),this.hideAddressBar(0,1),this.launchFixUI(5)};m.prototype={dX:0,dY:0,cX:0,cY:0,touchStartX:null,touchStartY:null,layer:null,scrollingEl_:null,scrollTimeoutEl_:null,scrollTimeout_:null,reshapeTimeout_:null,scrollEndedProxy_:null,exitEditProxy_:null,launchFixUIProxy_:null,reHideAddressBarTimeout_:null,retestAndFixUIProxy_:null,panElementId:"header",blockClicks:!1,allowDocumentScroll_:!1,ignoreNextResize_:!1,blockPossibleClick_:!1,isScrolling:!1,isScrollingVertical_:!1,wasPanning_:!1,isPanning_:!1,isFocused_:!1,justBlurred_:!1,requiresNativeTap:!1,holdingReshapeType_:null,trackingClick:!1,scrollerIsScrolling:!1,handleEvent:function(a){switch(a.type){case"touchstart":this.onTouchStart(a);break;case"touchmove":this.onTouchMove(a);break;case"touchend":this.onTouchEnd(a);break;case"click":this.onClick(a);break;case"blur":this.onBlur(a);break;case"scroll":this.onScroll(a);break;case"orientationchange":this.onOrientationChange(a);break;case"resize":this.onResize(a);break;case"focusin":this.onFocusIn(a)}},launchFixUI:function(a){return a||(a=i),null===this.reHideAddressBarTimeout_?this.testAndFixUI(0,a):void 0},resetFixUI:function(){this.reHideAddressBarTimeout_&&clearTimeout(this.reHideAddressBarTimeout_),this.reHideAddressBarTimeout_=null},testAndFixUI:function(b,c){var d=this.getReferenceHeight(),e=this.getCurrentHeight();return d===e||d>e*h&&e>d*h?(a.os.android&&this.resetFixUI(),!1):(this.hideAddressBar(b,c),!0)},hideAddressBar:function(b,c){if(!a.ui||!a.ui.isIntel){if(b>=c)return this.resetFixUI(),void 0;if(a.os.desktop||a.os.kindle)this.layer.style.height="100%";else if(a.os.android){window.scrollTo(1,1),this.layer.style.height=this.isFocused_||window.innerHeight>=window.outerHeight?window.innerHeight+"px":window.outerHeight+"px";var d=this,e=b+1;this.reHideAddressBarTimeout_=setTimeout(d.retestAndFixUIProxy_,250*e,e,c)}else this.isFocused_||(document.documentElement.style.height="5000px",window.scrollTo(0,0),document.documentElement.style.height=window.innerHeight+"px",this.layer.style.height=window.innerHeight+"px")}},getReferenceHeight:function(){return window.innerHeight},getCurrentHeight:function(){return a.os.android?window.innerHeight:numOnly(document.documentElement.style.height)},onOrientationChange:function(){var c=this,d=!1;if(this.focusedElement&&(d=!0,this.focusedElement.blur()),!this.holdingReshapeType_&&this.reshapeTimeout_?this.fireReshapeEvent("orientationchange"):this.previewReshapeEvent("orientationchange"),a.os.android&&a.os.chrome){this.layer.style.height="100%";var e=d?600:0;setTimeout(function(){c.hideAddressBar(0,1)},e)}},onResize:function(){return this.ignoreNextResize_?(this.ignoreNextResize_=!1,void 0):(this.launchFixUI()&&this.reshapeAction(),void 0)},onClick:function(e){var f=e.target&&void 0!==e.target.tagName?e.target.tagName.toLowerCase():"";if(-1===b.indexOf(f)||this.isFocused_&&e.target===this.focusedElement)a.os.blackberry10&&this.isFocused_&&this.focusedElement.blur();else{var g=e.target&&void 0!==e.target.type?e.target.type.toLowerCase():"",h=-1!==c.indexOf(g);if(h)this.isFocused_=!1;else{if(this.isFocused_&&this.focusedElement.removeEventListener("blur",this,!1),this.focusedElement=e.target,this.focusedElement.addEventListener("blur",this,!1),!this.isFocused_&&!this.justBlurred_)if(a.trigger(this,"enter-edit",[e.target]),a.os.ios){var i=this;setTimeout(function(){i.fireReshapeEvent("enter-edit")},300)}else this.previewReshapeEvent("enter-edit");this.isFocused_=!0}this.justBlurred_=!1,this.allowDocumentScroll_=!0,d&&e.target.focus()}},previewReshapeEvent:function(a){var b=this;this.reshapeTimeout_=setTimeout(function(){b.fireReshapeEvent(a),b.reshapeTimeout_=null,b.holdingReshapeType_=null},750),this.holdingReshapeType_=a},fireReshapeEvent:function(b){a.trigger(this,"reshape"),a.trigger(this,b?b+"-reshape":"unknown-reshape")},reshapeAction:function(){this.reshapeTimeout_?(clearTimeout(this.reshapeTimeout_),this.fireReshapeEvent(this.holdingReshapeType_),this.holdingReshapeType_=null,this.reshapeTimeout_=null):this.previewReshapeEvent()},onFocusIn:function(a){this.isFocused_||this.onClick(a)},onBlur:function(b){a.os.android&&b.target===window||(this.isFocused_=!1,this.focusedElement&&this.focusedElement.removeEventListener("blur",this,!1),this.focusedElement=null,this.justBlurred_=!0,a.asap(this.exitEditProxy_,this,[b.target]))},exitExit:function(b){if(this.justBlurred_=!1,!this.isFocused_)if(a.trigger(this,"exit-edit",[b]),this.allowDocumentScroll_=!1,a.os.ios){var c=this;setTimeout(function(){c.fireReshapeEvent("exit-edit")},300)}else this.previewReshapeEvent("exit-edit")},onScroll:function(a){this.allowDocumentScroll_||this.isPanning_||a.target!==document||(this.allowDocumentScroll_=!0,this.wasPanning_?(this.wasPanning_=!1,setTimeout(this.launchFixUIProxy_,2e3,[i])):this.launchFixUI())},onTouchStart:function(c){if(this.dX=c.touches[0].pageX,this.dY=c.touches[0].pageY,this.lastTimestamp=c.timeStamp,this.lastTouchStartX=this.lastTouchStartY=null,a.os.ios){if(j===c.touches[0].identifier)return k=!0,c.preventDefault(),j=!1,!1;j=c.touches[0].identifier,k=!1}if(this.scrollerIsScrolling)return this.moved=!0,this.scrollerIsScrolling=!1,c.preventDefault(),!1;this.trackingClick=!0,(g||a.feat.nativeTouchScroll)&&this.checkDOMTree(c.target,this.layer),this.isScrolling&&(null!==this.scrollTimeout_?(clearTimeout(this.scrollTimeout_),this.scrollTimeout_=null,this.scrollTimeoutEl_!==this.scrollingEl_?this.scrollEnded(!1):this.blockPossibleClick_=!0):this.scrollTimeoutEl_&&(this.scrollEnded(!0),this.blockPossibleClick_=!0));var d=a.os.android&&c&&c.target&&c.target.getAttribute&&"ignore"===c.target.getAttribute("data-touchlayer");if(d||this.isFocused_&&!a.os.blackberry10)this.requiresNativeTap=!0,this.allowDocumentScroll_=!0;else if(f&&c.target&&void 0!==c.target.tagName){var e=c.target.tagName.toLowerCase();-1!==b.indexOf(e)&&(this.requiresNativeTap=!0)}else c.target&&void 0!==c.target.tagName&&"input"===c.target.tagName.toLowerCase()&&"range"===c.target.type&&(this.requiresNativeTap=!0);a.os.chrome||a.os.fennec||(this.isPanning_||this.requiresNativeTap?this.isScrollingVertical_&&this.demandVerticalScroll():(this.isScrolling&&!a.feat.nativeTouchScroll||!this.isScrolling)&&c.preventDefault())},demandVerticalScroll:function(){var a=this.scrollingEl_.scrollTop<=0;if(a)this.scrollingEl_.scrollTop=1;else{var b=this.scrollingEl_.scrollTop+this.scrollingEl_.clientHeight,c=b>=this.scrollingEl_.scrollHeight;c&&(this.scrollingEl_.scrollTop=this.scrollingEl_.scrollHeight-this.scrollingEl_.clientHeight-1)}},ignoreScrolling:function(a){return void 0===a.scrollWidth||void 0===a.clientWidth?!0:void 0===a.scrollHeight||void 0===a.clientHeight?!0:!1},allowsVerticalScroll:function(a,b){var c=b.overflowY;return"scroll"===c?!0:"auto"===c&&a.scrollHeight>a.clientHeight?!0:!1},allowsHorizontalScroll:function(a,b){var c=b.overflowX;return"scroll"===c?!0:"auto"===c&&a.scrollWidth>a.clientWidth?!0:!1},checkDOMTree:function(b,c){if(g&&this.panElementId===b.id)return this.isPanning_=!0,void 0;if(a.feat.nativeTouchScroll){if(this.ignoreScrolling(b))return;var d=window.getComputedStyle(b);if(this.allowsVerticalScroll(b,d))return this.isScrollingVertical_=!0,this.scrollingEl_=b,this.isScrolling=!0,void 0;this.allowsHorizontalScroll(b,d)&&(this.isScrollingVertical_=!1,this.scrollingEl_=null,this.isScrolling=!0)}var e=b===c;!e&&b.parentNode&&this.checkDOMTree(b.parentNode,c)},scrollEnded:function(a){null!==this.scrollTimeoutEl_&&(a&&this.scrollTimeoutEl_.removeEventListener("scroll",this.scrollEndedProxy_,!1),this.fireEvent("UIEvents","scrollend",this.scrollTimeoutEl_,!1,!1),this.scrollTimeoutEl_=null)},onTouchMove:function(b){var c=this.moved;return this.moved=!0,e&&(this.cY=b.touches[0].pageY-this.dY,this.cX=b.touches[0].pageX-this.dX),this.isPanning_?void 0:(this.isScrolling&&(c||this.fireEvent("UIEvents","scrollstart",this.scrollingEl_,!1,!1),this.speedY=(this.lastY-b.touches[0].pageY)/(b.timeStamp-this.lastTimestamp),this.lastY=b.touches[0].pageY,this.lastX=b.touches[0].pageX,this.lastTimestamp=b.timeStamp),a.os.blackberry10?void 0:(this.isScrolling&&a.feat.nativeTouchScroll||b.preventDefault(),void 0))},onTouchEnd:function(b){var c=this.moved;if(e&&(c=c&&!(Math.abs(this.cX)<10&&Math.abs(this.cY)<10)),a.os.ios&&this.requiresNativeTap||(this.allowDocumentScroll_=!1),this.isPanning_&&c)this.wasPanning_=!0;else if(c||this.requiresNativeTap)c&&(this.isScrolling&&(this.scrollTimeoutEl_=this.scrollingEl_,Math.abs(this.speedY)<.01?this.scrollEnded(!1):this.scrollTimeout_=setTimeout(this.scrollTimeoutExpireProxy_,30)),this.requiresNativeTap&&(this.isFocused_||a.trigger(this,"cancel-enter-edit",[b.target])));else{if(this.scrollerIsScrolling=!1,!this.trackingClick)return;if(b.preventDefault(),!this.blockClicks&&!this.blockPossibleClick_){var d=b.target,f=b.changedTouches?b.changedTouches[0]:b.touches[0];3===d.nodeType&&(d=d.parentNode),this.fireEvent("Event","click",d,!0,b.mouseToTouch,f[0]),this.lastTouchStartX=this.dX,this.lastTouchStartY=this.dY}}a.os.blackberry10&&(this.lastTouchStartX=this.dX,this.lastTouchStartY=this.dY),this.clearTouchVars()},clearTouchVars:function(){this.speedY=this.lastY=this.cY=this.cX=this.dX=this.dY=0,this.moved=!1,this.isPanning_=!1,this.isScrolling=!1,this.isScrollingVertical_=!1,this.requiresNativeTap=!1,this.blockPossibleClick_=!1,this.trackingClick=!1},fireEvent:function(b,c,d,e,f,g){var h=document.createEvent(b);h.initEvent(c,e,!0),g&&a.each(g,function(a,b){h.key=b}),f&&(h.mouseToTouch=!0),d.dispatchEvent(h)}}}(af);